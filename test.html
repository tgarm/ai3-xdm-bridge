<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomys Transfer Test</title>
</head>
<body>
    <h1>Autonomys Consensus to EVM Transfer Test</h1>
    <p><strong>Note:</strong> Using Auto-SDK via esm.sh for browser compatibility. Switched to esm.sh for all imports to fix CORS. Test with tiny amounts on mainnet!</p>
    <button id="connectBtn">Connect Substrate Wallet</button>
    <div id="status"></div>
    <button id="transferBtn" disabled>Perform Test Transfer (0.001 AI3 to EVM Addr)</button>
    <script type="module">
        import { ApiPromise, WsProvider } from 'https://esm.sh/@polkadot/api@15.10.2';
        import { web3Enable, web3Accounts, web3FromAddress } from 'https://esm.sh/@polkadot/extension-dapp@0.59.2';
        import { decodeAddress, encodeAddress } from 'https://esm.sh/@polkadot/util-crypto@13.5.7';

        // Constants
        const NETWORK_ID = 'mainnet';
        const CONSENSUS_RPC = 'wss://rpc.mainnet.autonomys.xyz/ws'; // User-preferred current endpoint
        const AUTONOMYS_PREFIX = 6049; // SS58 prefix for Autonomys
        const DECIMALS = 18n; // AI3 decimals (shannons)
        const DOMAIN_ID = 0; // Auto EVM domain
        const TEST_AMOUNT = (1n*10n**DECIMALS).toString(); // 1 AI3 in shannons
        const TEST_EVM_ADDR = '0xDD6CFC7622371C41E5FC522D88845960251F25eC'; // From logs

        // Elements
        const statusEl = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const transferBtn = document.getElementById('transferBtn');

        let api = null;
        let injector = null;
        let account = null;
        let address = '';

        // Log function
        function addLog(msg) {
            console.log(`[TEST] ${new Date().toISOString()}: ${msg}`);
            statusEl.innerHTML += `<p>${msg}</p>`;
            statusEl.scrollTop = statusEl.scrollHeight;
        }

        // Create API instance
        async function createApiInstance() {
            try {
                addLog('Creating API instance...');
                const provider = new WsProvider(CONSENSUS_RPC);
                const apiInstance = await ApiPromise.create({
                    provider,
                    types: {
                        // Core types from SDK/docs + fix for SpDomainsChainId
                        AccountId20: '[u8;20]',
                        DomainId: 'u32',
                        ChainId: 'u32',
                        SpDomainsChainId: 'u32', // Registers the missing type (u32 alias)
                        // XCM for dest if needed by SDK internals
                        MultiLocation: {
                            parents: 'u8',
                            interior: 'Junctions'
                        },
                        Junctions: {
                            _enum: {
                                Here: null,
                                X1: 'Junction'
                            }
                        },
                        Junction: {
                            _enum: {
                                AccountId20: 'AccountId20'
                            }
                        }
                    }
                });

                // Refresh metadata (critical for runtime types)
                const metadata = await apiInstance.rpc.state.getMetadata();
                apiInstance.registry.setMetadata(metadata);
                addLog('Metadata refreshed for mainnet custom types');

                await apiInstance.isReady;

                // Validate chain
                const chain = await apiInstance.rpc.system.chain();
                const expectedName = 'Autonomys Mainnet';
                addLog(`Connected to ${chain} (expected: ${expectedName})`);

                // Verify SDK-required types
                if (apiInstance.registry.get('SpDomainsChainId') && apiInstance.registry.get('AccountId20')) {
                    addLog('SDK types (SpDomainsChainId, AccountId20) registered successfully');
                } else {
                    throw new Error('SDK type registration failed');
                }

                return apiInstance;
            } catch (error) {
                addLog(`Error creating API: ${error.message}`);
                throw error;
            }
        }

        // Connect wallet
        async function connectWallet() {
            try {
                addLog('Enabling Polkadot extension...');
                await web3Enable('autonomys-test-dapp');

                const allAccounts = await web3Accounts();
                if (allAccounts.length === 0) {
                    throw new Error('No accounts found. Install/Unlock SubWallet or Talisman.');
                }

                account = allAccounts[0];
                const publicKey = decodeAddress(account.address);
                address = encodeAddress(publicKey, AUTONOMYS_PREFIX);

                addLog(`Connected account: ${address}`);

                // Create API with SDK types
                api = await createApiInstance();

                // Get injector for extension signing
                injector = await web3FromAddress(account.address);
                if (!injector) {
                    throw new Error('No injector for address');
                }
                api.setSigner(injector.signer);

                // Update balance
                const { data: { free } } = await api.query.system.account(address);
                const balance = Number(free) / Number(10n ** DECIMALS);
                addLog(`Balance: ${balance.toFixed(4)} AI3`);

                // Dry-run SDK call to validate
                try {
                    const { transferToDomainAccount20Type } = await import('https://esm.sh/@autonomys/auto-xdm@1.5.18');
                    const dryTx = await transferToDomainAccount20Type(api, DOMAIN_ID, TEST_EVM_ADDR, '0');
                    const args = dryTx.method.toHuman().args;
                    addLog(`SDK dry-run success: Domain ${args.domainId || 'N/A'}, Account ${args.account || 'N/A'}`);
                } catch (dryErr) {
                    addLog(`SDK dry-run failed: ${dryErr.message}`);
                }

                connectBtn.disabled = true;
                transferBtn.disabled = false;

                addLog('Connection successful - ready for transfer');
            } catch (error) {
                addLog(`Connection failed: ${error.message}`);
                alert(error.message);
            }
        }

        // Perform transfer using Auto-SDK
        async function performTransfer() {
            if (!api || !injector) {
                addLog('Not connected');
                return;
            }

            try {
                addLog(`Preparing Auto-SDK transfer to Domain ${DOMAIN_ID}, EVM: ${TEST_EVM_ADDR}, Amount: ${TEST_AMOUNT}`);

                // Load Auto-SDK
                const { transferToDomainAccount20Type } = await import('https://esm.sh/@autonomys/auto-xdm@1.5.18');
                addLog('Auto-XDM SDK loaded');

                const tx = await transferToDomainAccount20Type(
                    api,
                    DOMAIN_ID,
                    TEST_EVM_ADDR,
                    TEST_AMOUNT
                );

                addLog('Extrinsic prepared via Auto-SDK - signing and sending...');

                const unsubscribe = await tx.signAndSend(address, ({ status }) => {
                    addLog(`Status: ${status.type}`);
                    if (status.isInBlock) {
                        addLog(`In block: ${status.asInBlock.toHex()}`);
                    }
                    if (status.isFinalized) {
                        addLog(`Finalized: ${status.asFinalized.toHex()}`);
                        unsubscribe();
                    }
                    if (status.isDropped || status.isInvalid) {
                        addLog(`Failed: ${status.type}`);
                        unsubscribe();
                    }
                });

                addLog('Transaction sent - monitor via Polkadot.js Apps');
            } catch (error) {
                addLog(`Transfer failed: ${error.message}`);
                console.error(error);
                alert(error.message);
            }
        }

        // Event listeners
        connectBtn.addEventListener('click', connectWallet);
        transferBtn.addEventListener('click', performTransfer);

        addLog('Test page loaded - click Connect to start');
    </script>
</body>
</html>